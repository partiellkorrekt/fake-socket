"use strict";var e={},t={},n=!1,o=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];n&&console.log.apply(console,e)},r=function(e){t[e]=0},a=0,s=1,i=2,c=3,h=function(){function h(n,h){var l=this;this._fakeUrl="",this.isFakeSocket=!1,this._readyState=a,this._eventTarget=new EventTarget,this.onopen=null,this.onclose=null,this.onmessage=null,this.onerror=null,this.handleOpen=function(){l.isFakeSocket&&console.warn("Connected via FakeSocket"),o("🟢 Open",{isFakeSocket:l.isFakeSocket}),l.isFakeSocket||r(l.url);var e=new Event("open");l.onopen&&l.onopen(e),l.dispatchEvent(e)},this.handleError=function(){o("🟡 Error",{isFakeSocket:l.isFakeSocket}),!l.isFakeSocket&&l._wSocket&&l._wSocket.readyState===c&&function(e){t[e]=(t[e]||0)+1,console.warn("Connection to Websocket failed: "+t[e]+" of 3")}(l.url);var e=new Event("error");l.onerror&&l.onerror(e),l.dispatchEvent(e)},this.handleMessage=function(e){var t=e.data;o("⏬ Receive",t);var n=new MessageEvent("message",{data:t,origin:l.origin});l.onmessage&&l.onmessage(n),l.dispatchEvent(n)},this.handleClose=function(e){o("🔴 Close",{code:e.code,reason:e.reason,wasClean:e.wasClean});var t=e.code,n=e.reason,r=e.wasClean,a=new CloseEvent("close",{code:t,reason:n,wasClean:r});l.onclose&&l.onclose(a),l.dispatchEvent(a)},this.CLOSED=c,this.CLOSING=i,this.CONNECTING=a,this.OPEN=s,this.handleFakeResponse=function(e){e.socket&&(e.socket.buffer&&e.socket.buffer.forEach((function(e){"message"===e.type&&l.handleMessage({data:e.data}),"error"===e.type&&l.handleError()})),e.socket.readyState!==l._readyState&&(l._readyState=e.socket.readyState,3===l.readyState&&l.handleClose({code:e.socket.closeReason,reason:e.socket.closeReasonName})))},this._hasPanicked=!1,this.handleNetworkError=function(){l.isFakeSocket&&!l._hasPanicked&&(l._hasPanicked=!0,console.warn("FakeSocket encountered a network error. Trying to open a real socket."),r(l.url),l.readyState<3&&l.handleClose({code:1006,reason:"Network Error",wasClean:!1}))},this._busy=!1,this._currentTransaction=Promise.resolve(),this._sendBuffer=[],this.onInterval=function(){l.isFakeSocket&&!l._busy&&l._currentTransaction.then((function(){l._busy=!0,l._currentTransaction=fetch(l._fakeUrl,{method:"GET"}).then((function(e){return e.json()})).then((function(e){l.handleFakeResponse(e),l._busy=!1})).catch(l.handleNetworkError).then((function(){l.readyState<3&&setTimeout(l.onInterval,1e3)}))}))},this.url=n,this.origin=n.split("/").slice(0,3).join("/"),!function(e){return!t[e]||t[e]<3}(n)&&e[n]?(this.isFakeSocket=!0,console.warn("Failed to open a real websocket. Trying to open a fake socket."),setTimeout(this.onInterval,1e3),fetch(e[n],{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({protocols:Array.isArray(h)?h:[h]})}).then((function(e){return e.json().then((function(t){return{request:e,data:t}}))})).then((function(e){var t=e.request,n=e.data;if(!t.ok)throw{reason:n.socket.closeReasonName,code:n.socket.closeReason};return n})).then((function(e){l._fakeUrl=e.url,l._readyState=s,l.handleOpen()})).catch((function(e){var t=e||{},n=t.reason,o=void 0===n?"Connection failed":n,r=t.code,a=void 0===r?1006:r;l._readyState=3,l.handleClose({reason:o||"Connection failed",code:a||1006,wasClean:!1}),l.handleNetworkError()}))):(this._wSocket=new WebSocket(n,h),this._wSocket.onopen=this.handleOpen,this._wSocket.onclose=this.handleClose,this._wSocket.onmessage=this.handleMessage,this._wSocket.onerror=this.handleError)}return h.addAlternative=function(t,n){e[t]=n},h.setLoggingEnabled=function(e){n=e},h.prototype.addEventListener=function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];(e=this._eventTarget).addEventListener.apply(e,t)},h.prototype.dispatchEvent=function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return(e=this._eventTarget).dispatchEvent.apply(e,t)},h.prototype.removeEventListener=function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return(e=this._eventTarget).removeEventListener.apply(e,t)},Object.defineProperty(h.prototype,"binaryType",{get:function(){return this._wSocket?this._wSocket.binaryType:"blob"},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"bufferedAmount",{get:function(){return this._wSocket?this._wSocket.bufferedAmount:0},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"extensions",{get:function(){return this._wSocket?this._wSocket.extensions:""},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"protocol",{get:function(){return this._wSocket?this._wSocket.protocol:""},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"readyState",{get:function(){return this._wSocket?this._wSocket.readyState:this._readyState},enumerable:!1,configurable:!0}),h.prototype.send=function(e){var t=this;o("⏫ Send",e),this.isFakeSocket?(this._sendBuffer.push(e.toString()),this._currentTransaction.then((function(){if(t._sendBuffer.length){t._busy=!0;var e=JSON.stringify(t._sendBuffer);t._sendBuffer=[],t._currentTransaction=fetch(t._fakeUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:e}).then((function(e){return e.json()})).then((function(e){t.handleFakeResponse(e),t._busy=!1})).catch(t.handleNetworkError)}}))):this._wSocket&&this._wSocket.send(e)},h.prototype.close=function(e,t){this._wSocket&&this._wSocket.close(e,t)},h.CLOSED=c,h.CLOSING=i,h.CONNECTING=a,h.OPEN=s,h}();module.exports=h;
