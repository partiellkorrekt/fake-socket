"use strict";var e=require("stream"),t=require("zlib"),s=require("buffer"),r=require("crypto"),o=require("events"),i=require("https"),n=require("http"),a=require("net"),c=require("tls"),h=require("url");let l;const d=new Uint8Array(16);function f(){if(!l&&(l="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!l))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return l(d)}const u=[];for(let e=0;e<256;++e)u.push((e+256).toString(16).slice(1));var _={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function p(e,t,s){if(_.randomUUID&&!t&&!e)return _.randomUUID();const r=(e=e||{}).random||(e.rng||f)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){s=s||0;for(let e=0;e<16;++e)t[s+e]=r[e];return t}return function(e,t=0){return u[e[t+0]]+u[e[t+1]]+u[e[t+2]]+u[e[t+3]]+"-"+u[e[t+4]]+u[e[t+5]]+"-"+u[e[t+6]]+u[e[t+7]]+"-"+u[e[t+8]]+u[e[t+9]]+"-"+u[e[t+10]]+u[e[t+11]]+u[e[t+12]]+u[e[t+13]]+u[e[t+14]]+u[e[t+15]]}(r)}function m(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var y={exports:{}},g={BINARY_TYPES:["nodebuffer","arraybuffer","fragments"],EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}};const{EMPTY_BUFFER:v}=g,b=Buffer[Symbol.species];function k(e,t,s,r,o){for(let i=0;i<o;i++)s[r+i]=e[i]^t[3&i]}function S(e,t){for(let s=0;s<e.length;s++)e[s]^=t[3&s]}if(y.exports={concat:function(e,t){if(0===e.length)return v;if(1===e.length)return e[0];const s=Buffer.allocUnsafe(t);let r=0;for(let t=0;t<e.length;t++){const o=e[t];s.set(o,r),r+=o.length}return r<t?new b(s.buffer,s.byteOffset,r):s},mask:k,toArrayBuffer:function(e){return e.length===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.length)},toBuffer:function e(t){if(e.readOnly=!0,Buffer.isBuffer(t))return t;let s;return t instanceof ArrayBuffer?s=new b(t):ArrayBuffer.isView(t)?s=new b(t.buffer,t.byteOffset,t.byteLength):(s=Buffer.from(t),e.readOnly=!1),s},unmask:S},!process.env.WS_NO_BUFFER_UTIL)try{const e=require("bufferutil");y.exports.mask=function(t,s,r,o,i){i<48?k(t,s,r,o,i):e.mask(t,s,r,o,i)},y.exports.unmask=function(t,s){t.length<32?S(t,s):e.unmask(t,s)}}catch(e){}var E=y.exports;const w=Symbol("kDone"),x=Symbol("kRun");const O=t,N=E,T=class{constructor(e){this[w]=()=>{this.pending--,this[x]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[x]()}[x](){if(this.pending!==this.concurrency&&this.jobs.length){const e=this.jobs.shift();this.pending++,e(this[w])}}},{kStatusCode:C}=g,L=Buffer[Symbol.species],R=Buffer.from([0,0,255,255]),P=Symbol("permessage-deflate"),U=Symbol("total-length"),B=Symbol("callback"),I=Symbol("buffers"),A=Symbol("error");let M;var D=class{constructor(e,t,s){if(this._maxPayload=0|s,this._options=e||{},this._threshold=void 0!==this._options.threshold?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!M){const e=void 0!==this._options.concurrencyLimit?this._options.concurrencyLimit:10;M=new T(e)}}static get extensionName(){return"permessage-deflate"}offer(){const e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:null==this._options.clientMaxWindowBits&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){const e=this._deflate[B];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){const t=this._options,s=e.find((e=>!(!1===t.serverNoContextTakeover&&e.server_no_context_takeover||e.server_max_window_bits&&(!1===t.serverMaxWindowBits||"number"==typeof t.serverMaxWindowBits&&t.serverMaxWindowBits>e.server_max_window_bits)||"number"==typeof t.clientMaxWindowBits&&!e.client_max_window_bits)));if(!s)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(s.server_no_context_takeover=!0),t.clientNoContextTakeover&&(s.client_no_context_takeover=!0),"number"==typeof t.serverMaxWindowBits&&(s.server_max_window_bits=t.serverMaxWindowBits),"number"==typeof t.clientMaxWindowBits?s.client_max_window_bits=t.clientMaxWindowBits:!0!==s.client_max_window_bits&&!1!==t.clientMaxWindowBits||delete s.client_max_window_bits,s}acceptAsClient(e){const t=e[0];if(!1===this._options.clientNoContextTakeover&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(t.client_max_window_bits){if(!1===this._options.clientMaxWindowBits||"number"==typeof this._options.clientMaxWindowBits&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"')}else"number"==typeof this._options.clientMaxWindowBits&&(t.client_max_window_bits=this._options.clientMaxWindowBits);return t}normalizeParams(e){return e.forEach((e=>{Object.keys(e).forEach((t=>{let s=e[t];if(s.length>1)throw new Error(`Parameter "${t}" must have only a single value`);if(s=s[0],"client_max_window_bits"===t){if(!0!==s){const e=+s;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${s}`);s=e}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${t}": ${s}`)}else if("server_max_window_bits"===t){const e=+s;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${s}`);s=e}else{if("client_no_context_takeover"!==t&&"server_no_context_takeover"!==t)throw new Error(`Unknown parameter "${t}"`);if(!0!==s)throw new TypeError(`Invalid value for parameter "${t}": ${s}`)}e[t]=s}))})),e}decompress(e,t,s){M.add((r=>{this._decompress(e,t,((e,t)=>{r(),s(e,t)}))}))}compress(e,t,s){M.add((r=>{this._compress(e,t,((e,t)=>{r(),s(e,t)}))}))}_decompress(e,t,s){const r=this._isServer?"client":"server";if(!this._inflate){const e=`${r}_max_window_bits`,t="number"!=typeof this.params[e]?O.Z_DEFAULT_WINDOWBITS:this.params[e];this._inflate=O.createInflateRaw({...this._options.zlibInflateOptions,windowBits:t}),this._inflate[P]=this,this._inflate[U]=0,this._inflate[I]=[],this._inflate.on("error",j),this._inflate.on("data",F)}this._inflate[B]=s,this._inflate.write(e),t&&this._inflate.write(R),this._inflate.flush((()=>{const e=this._inflate[A];if(e)return this._inflate.close(),this._inflate=null,void s(e);const o=N.concat(this._inflate[I],this._inflate[U]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[U]=0,this._inflate[I]=[],t&&this.params[`${r}_no_context_takeover`]&&this._inflate.reset()),s(null,o)}))}_compress(e,t,s){const r=this._isServer?"server":"client";if(!this._deflate){const e=`${r}_max_window_bits`,t="number"!=typeof this.params[e]?O.Z_DEFAULT_WINDOWBITS:this.params[e];this._deflate=O.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:t}),this._deflate[U]=0,this._deflate[I]=[],this._deflate.on("data",W)}this._deflate[B]=s,this._deflate.write(e),this._deflate.flush(O.Z_SYNC_FLUSH,(()=>{if(!this._deflate)return;let e=N.concat(this._deflate[I],this._deflate[U]);t&&(e=new L(e.buffer,e.byteOffset,e.length-4)),this._deflate[B]=null,this._deflate[U]=0,this._deflate[I]=[],t&&this.params[`${r}_no_context_takeover`]&&this._deflate.reset(),s(null,e)}))}};function W(e){this[I].push(e),this[U]+=e.length}function F(e){this[U]+=e.length,this[P]._maxPayload<1||this[U]<=this[P]._maxPayload?this[I].push(e):(this[A]=new RangeError("Max payload size exceeded"),this[A].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[A][C]=1009,this.removeListener("data",F),this.reset())}function j(e){this[P]._inflate=null,e[C]=1007,this[B](e)}var G={exports:{}};const{isUtf8:V}=s;function q(e){const t=e.length;let s=0;for(;s<t;)if(0==(128&e[s]))s++;else if(192==(224&e[s])){if(s+1===t||128!=(192&e[s+1])||192==(254&e[s]))return!1;s+=2}else if(224==(240&e[s])){if(s+2>=t||128!=(192&e[s+1])||128!=(192&e[s+2])||224===e[s]&&128==(224&e[s+1])||237===e[s]&&160==(224&e[s+1]))return!1;s+=3}else{if(240!=(248&e[s]))return!1;if(s+3>=t||128!=(192&e[s+1])||128!=(192&e[s+2])||128!=(192&e[s+3])||240===e[s]&&128==(240&e[s+1])||244===e[s]&&e[s+1]>143||e[s]>244)return!1;s+=4}return!0}if(G.exports={isValidStatusCode:function(e){return e>=1e3&&e<=1014&&1004!==e&&1005!==e&&1006!==e||e>=3e3&&e<=4999},isValidUTF8:q,tokenChars:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0]},V)G.exports.isValidUTF8=function(e){return e.length<24?q(e):V(e)};else if(!process.env.WS_NO_UTF_8_VALIDATE)try{const e=require("utf-8-validate");G.exports.isValidUTF8=function(t){return t.length<32?q(t):e(t)}}catch(e){}var $=G.exports;const{Writable:H}=e,z=D,{BINARY_TYPES:Y,EMPTY_BUFFER:X,kStatusCode:K,kWebSocket:Z}=g,{concat:J,toArrayBuffer:Q,unmask:ee}=E,{isValidStatusCode:te,isValidUTF8:se}=$,re=Buffer[Symbol.species],oe=Promise.resolve(),ie="function"==typeof queueMicrotask?queueMicrotask:function(e){oe.then(e).catch(ce)};var ne=class extends H{constructor(e={}){super(),this._allowSynchronousEvents=!!e.allowSynchronousEvents,this._binaryType=e.binaryType||Y[0],this._extensions=e.extensions||{},this._isServer=!!e.isServer,this._maxPayload=0|e.maxPayload,this._skipUTF8Validation=!!e.skipUTF8Validation,this[Z]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._errored=!1,this._loop=!1,this._state=0}_write(e,t,s){if(8===this._opcode&&0==this._state)return s();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(s)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){const t=this._buffers[0];return this._buffers[0]=new re(t.buffer,t.byteOffset+e,t.length-e),new re(t.buffer,t.byteOffset,e)}const t=Buffer.allocUnsafe(e);do{const s=this._buffers[0],r=t.length-e;e>=s.length?t.set(this._buffers.shift(),r):(t.set(new Uint8Array(s.buffer,s.byteOffset,e),r),this._buffers[0]=new re(s.buffer,s.byteOffset+e,s.length-e)),e-=s.length}while(e>0);return t}startLoop(e){this._loop=!0;do{switch(this._state){case 0:this.getInfo(e);break;case 1:this.getPayloadLength16(e);break;case 2:this.getPayloadLength64(e);break;case 3:this.getMask();break;case 4:this.getData(e);break;case 5:case 6:return void(this._loop=!1)}}while(this._loop);this._errored||e()}getInfo(e){if(this._bufferedBytes<2)return void(this._loop=!1);const t=this.consume(2);if(0!=(48&t[0])){return void e(this.createError(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3"))}const s=64==(64&t[0]);if(!s||this._extensions[z.extensionName]){if(this._fin=128==(128&t[0]),this._opcode=15&t[0],this._payloadLength=127&t[1],0===this._opcode){if(s){return void e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"))}if(!this._fragmented){return void e(this.createError(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE"))}this._opcode=this._fragmented}else if(1===this._opcode||2===this._opcode){if(this._fragmented){return void e(this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE"))}this._compressed=s}else{if(!(this._opcode>7&&this._opcode<11)){return void e(this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE"))}if(!this._fin){return void e(this.createError(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN"))}if(s){return void e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"))}if(this._payloadLength>125||8===this._opcode&&1===this._payloadLength){return void e(this.createError(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH"))}}if(this._fin||this._fragmented||(this._fragmented=this._opcode),this._masked=128==(128&t[1]),this._isServer){if(!this._masked){return void e(this.createError(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK"))}}else if(this._masked){return void e(this.createError(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK"))}126===this._payloadLength?this._state=1:127===this._payloadLength?this._state=2:this.haveLength(e)}else{e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"))}}getPayloadLength16(e){this._bufferedBytes<2?this._loop=!1:(this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength(e))}getPayloadLength64(e){if(this._bufferedBytes<8)return void(this._loop=!1);const t=this.consume(8),s=t.readUInt32BE(0);if(s>Math.pow(2,21)-1){e(this.createError(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH"))}else this._payloadLength=s*Math.pow(2,32)+t.readUInt32BE(4),this.haveLength(e)}haveLength(e){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0)){e(this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH"))}else this._masked?this._state=3:this._state=4}getMask(){this._bufferedBytes<4?this._loop=!1:(this._mask=this.consume(4),this._state=4)}getData(e){let t=X;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength)return void(this._loop=!1);t=this.consume(this._payloadLength),this._masked&&0!=(this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3])&&ee(t,this._mask)}if(this._opcode>7)this.controlMessage(t,e);else{if(this._compressed)return this._state=5,void this.decompress(t,e);t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage(e)}}decompress(e,t){this._extensions[z.extensionName].decompress(e,this._fin,((e,s)=>{if(e)return t(e);if(s.length){if(this._messageLength+=s.length,this._messageLength>this._maxPayload&&this._maxPayload>0){const e=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");return void t(e)}this._fragments.push(s)}this.dataMessage(t),0===this._state&&this.startLoop(t)}))}dataMessage(e){if(!this._fin)return void(this._state=0);const t=this._messageLength,s=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],2===this._opcode){let r;r="nodebuffer"===this._binaryType?J(s,t):"arraybuffer"===this._binaryType?Q(J(s,t)):s,5===this._state||this._allowSynchronousEvents?(this.emit("message",r,!0),this._state=0):(this._state=6,ie((()=>{this.emit("message",r,!0),this._state=0,this.startLoop(e)})))}else{const r=J(s,t);if(!this._skipUTF8Validation&&!se(r)){const t=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");return void e(t)}5===this._state||this._allowSynchronousEvents?(this.emit("message",r,!1),this._state=0):(this._state=6,ie((()=>{this.emit("message",r,!1),this._state=0,this.startLoop(e)})))}}controlMessage(e,t){if(8!==this._opcode)this._allowSynchronousEvents?(this.emit(9===this._opcode?"ping":"pong",e),this._state=0):(this._state=6,ie((()=>{this.emit(9===this._opcode?"ping":"pong",e),this._state=0,this.startLoop(t)})));else{if(0===e.length)this._loop=!1,this.emit("conclude",1005,X),this.end();else{const s=e.readUInt16BE(0);if(!te(s)){const e=this.createError(RangeError,`invalid status code ${s}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");return void t(e)}const r=new re(e.buffer,e.byteOffset+2,e.length-2);if(!this._skipUTF8Validation&&!se(r)){const e=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");return void t(e)}this._loop=!1,this.emit("conclude",s,r),this.end()}this._state=0}}createError(e,t,s,r,o){this._loop=!1,this._errored=!0;const i=new e(s?`Invalid WebSocket frame: ${t}`:t);return Error.captureStackTrace(i,this.createError),i.code=o,i[K]=r,i}};function ae(e){throw e}function ce(e){process.nextTick(ae,e)}const{randomFillSync:he}=r,le=D,{EMPTY_BUFFER:de}=g,{isValidStatusCode:fe}=$,{mask:ue,toBuffer:_e}=E,pe=Symbol("kByteLength"),me=Buffer.alloc(4);var ye=class e{constructor(e,t,s){this._extensions=t||{},s&&(this._generateMask=s,this._maskBuffer=Buffer.alloc(4)),this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._deflating=!1,this._queue=[]}static frame(e,t){let s,r,o=!1,i=2,n=!1;t.mask&&(s=t.maskBuffer||me,t.generateMask?t.generateMask(s):he(s,0,4),n=0==(s[0]|s[1]|s[2]|s[3]),i=6),"string"==typeof e?r=t.mask&&!n||void 0===t[pe]?(e=Buffer.from(e)).length:t[pe]:(r=e.length,o=t.mask&&t.readOnly&&!n);let a=r;r>=65536?(i+=8,a=127):r>125&&(i+=2,a=126);const c=Buffer.allocUnsafe(o?r+i:i);return c[0]=t.fin?128|t.opcode:t.opcode,t.rsv1&&(c[0]|=64),c[1]=a,126===a?c.writeUInt16BE(r,2):127===a&&(c[2]=c[3]=0,c.writeUIntBE(r,4,6)),t.mask?(c[1]|=128,c[i-4]=s[0],c[i-3]=s[1],c[i-2]=s[2],c[i-1]=s[3],n?[c,e]:o?(ue(e,s,c,i,r),[c]):(ue(e,s,e,0,r),[c,e])):[c,e]}close(t,s,r,o){let i;if(void 0===t)i=de;else{if("number"!=typeof t||!fe(t))throw new TypeError("First argument must be a valid error code number");if(void 0!==s&&s.length){const e=Buffer.byteLength(s);if(e>123)throw new RangeError("The message must not be greater than 123 bytes");i=Buffer.allocUnsafe(2+e),i.writeUInt16BE(t,0),"string"==typeof s?i.write(s,2):i.set(s,2)}else i=Buffer.allocUnsafe(2),i.writeUInt16BE(t,0)}const n={[pe]:i.length,fin:!0,generateMask:this._generateMask,mask:r,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};this._deflating?this.enqueue([this.dispatch,i,!1,n,o]):this.sendFrame(e.frame(i,n),o)}ping(t,s,r){let o,i;if("string"==typeof t?(o=Buffer.byteLength(t),i=!1):(o=(t=_e(t)).length,i=_e.readOnly),o>125)throw new RangeError("The data size must not be greater than 125 bytes");const n={[pe]:o,fin:!0,generateMask:this._generateMask,mask:s,maskBuffer:this._maskBuffer,opcode:9,readOnly:i,rsv1:!1};this._deflating?this.enqueue([this.dispatch,t,!1,n,r]):this.sendFrame(e.frame(t,n),r)}pong(t,s,r){let o,i;if("string"==typeof t?(o=Buffer.byteLength(t),i=!1):(o=(t=_e(t)).length,i=_e.readOnly),o>125)throw new RangeError("The data size must not be greater than 125 bytes");const n={[pe]:o,fin:!0,generateMask:this._generateMask,mask:s,maskBuffer:this._maskBuffer,opcode:10,readOnly:i,rsv1:!1};this._deflating?this.enqueue([this.dispatch,t,!1,n,r]):this.sendFrame(e.frame(t,n),r)}send(t,s,r){const o=this._extensions[le.extensionName];let i,n,a=s.binary?2:1,c=s.compress;if("string"==typeof t?(i=Buffer.byteLength(t),n=!1):(i=(t=_e(t)).length,n=_e.readOnly),this._firstFragment?(this._firstFragment=!1,c&&o&&o.params[o._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(c=i>=o._threshold),this._compress=c):(c=!1,a=0),s.fin&&(this._firstFragment=!0),o){const e={[pe]:i,fin:s.fin,generateMask:this._generateMask,mask:s.mask,maskBuffer:this._maskBuffer,opcode:a,readOnly:n,rsv1:c};this._deflating?this.enqueue([this.dispatch,t,this._compress,e,r]):this.dispatch(t,this._compress,e,r)}else this.sendFrame(e.frame(t,{[pe]:i,fin:s.fin,generateMask:this._generateMask,mask:s.mask,maskBuffer:this._maskBuffer,opcode:a,readOnly:n,rsv1:!1}),r)}dispatch(t,s,r,o){if(!s)return void this.sendFrame(e.frame(t,r),o);const i=this._extensions[le.extensionName];this._bufferedBytes+=r[pe],this._deflating=!0,i.compress(t,r.fin,((t,s)=>{if(this._socket.destroyed){const e=new Error("The socket was closed while data was being compressed");"function"==typeof o&&o(e);for(let t=0;t<this._queue.length;t++){const s=this._queue[t],r=s[s.length-1];"function"==typeof r&&r(e)}}else this._bufferedBytes-=r[pe],this._deflating=!1,r.readOnly=!1,this.sendFrame(e.frame(s,r),o),this.dequeue()}))}dequeue(){for(;!this._deflating&&this._queue.length;){const e=this._queue.shift();this._bufferedBytes-=e[3][pe],Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[3][pe],this._queue.push(e)}sendFrame(e,t){2===e.length?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}};const{kForOnEventAttribute:ge,kListener:ve}=g,be=Symbol("kCode"),ke=Symbol("kData"),Se=Symbol("kError"),Ee=Symbol("kMessage"),we=Symbol("kReason"),xe=Symbol("kTarget"),Oe=Symbol("kType"),Ne=Symbol("kWasClean");class Te{constructor(e){this[xe]=null,this[Oe]=e}get target(){return this[xe]}get type(){return this[Oe]}}Object.defineProperty(Te.prototype,"target",{enumerable:!0}),Object.defineProperty(Te.prototype,"type",{enumerable:!0});class Ce extends Te{constructor(e,t={}){super(e),this[be]=void 0===t.code?0:t.code,this[we]=void 0===t.reason?"":t.reason,this[Ne]=void 0!==t.wasClean&&t.wasClean}get code(){return this[be]}get reason(){return this[we]}get wasClean(){return this[Ne]}}Object.defineProperty(Ce.prototype,"code",{enumerable:!0}),Object.defineProperty(Ce.prototype,"reason",{enumerable:!0}),Object.defineProperty(Ce.prototype,"wasClean",{enumerable:!0});class Le extends Te{constructor(e,t={}){super(e),this[Se]=void 0===t.error?null:t.error,this[Ee]=void 0===t.message?"":t.message}get error(){return this[Se]}get message(){return this[Ee]}}Object.defineProperty(Le.prototype,"error",{enumerable:!0}),Object.defineProperty(Le.prototype,"message",{enumerable:!0});class Re extends Te{constructor(e,t={}){super(e),this[ke]=void 0===t.data?null:t.data}get data(){return this[ke]}}Object.defineProperty(Re.prototype,"data",{enumerable:!0});const Pe={addEventListener(e,t,s={}){for(const r of this.listeners(e))if(!s[ge]&&r[ve]===t&&!r[ge])return;let r;if("message"===e)r=function(e,s){const r=new Re("message",{data:s?e:e.toString()});r[xe]=this,Be(t,this,r)};else if("close"===e)r=function(e,s){const r=new Ce("close",{code:e,reason:s.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});r[xe]=this,Be(t,this,r)};else if("error"===e)r=function(e){const s=new Le("error",{error:e,message:e.message});s[xe]=this,Be(t,this,s)};else{if("open"!==e)return;r=function(){const e=new Te("open");e[xe]=this,Be(t,this,e)}}r[ge]=!!s[ge],r[ve]=t,s.once?this.once(e,r):this.on(e,r)},removeEventListener(e,t){for(const s of this.listeners(e))if(s[ve]===t&&!s[ge]){this.removeListener(e,s);break}}};var Ue={CloseEvent:Ce,ErrorEvent:Le,Event:Te,EventTarget:Pe,MessageEvent:Re};function Be(e,t,s){"object"==typeof e&&e.handleEvent?e.handleEvent.call(e,s):e.call(t,s)}const{tokenChars:Ie}=$;function Ae(e,t,s){void 0===e[t]?e[t]=[s]:e[t].push(s)}var Me={format:function(e){return Object.keys(e).map((t=>{let s=e[t];return Array.isArray(s)||(s=[s]),s.map((e=>[t].concat(Object.keys(e).map((t=>{let s=e[t];return Array.isArray(s)||(s=[s]),s.map((e=>!0===e?t:`${t}=${e}`)).join("; ")}))).join("; "))).join(", ")})).join(", ")},parse:function(e){const t=Object.create(null);let s,r,o=Object.create(null),i=!1,n=!1,a=!1,c=-1,h=-1,l=-1,d=0;for(;d<e.length;d++)if(h=e.charCodeAt(d),void 0===s)if(-1===l&&1===Ie[h])-1===c&&(c=d);else if(0===d||32!==h&&9!==h){if(59!==h&&44!==h)throw new SyntaxError(`Unexpected character at index ${d}`);{if(-1===c)throw new SyntaxError(`Unexpected character at index ${d}`);-1===l&&(l=d);const r=e.slice(c,l);44===h?(Ae(t,r,o),o=Object.create(null)):s=r,c=l=-1}}else-1===l&&-1!==c&&(l=d);else if(void 0===r)if(-1===l&&1===Ie[h])-1===c&&(c=d);else if(32===h||9===h)-1===l&&-1!==c&&(l=d);else if(59===h||44===h){if(-1===c)throw new SyntaxError(`Unexpected character at index ${d}`);-1===l&&(l=d),Ae(o,e.slice(c,l),!0),44===h&&(Ae(t,s,o),o=Object.create(null),s=void 0),c=l=-1}else{if(61!==h||-1===c||-1!==l)throw new SyntaxError(`Unexpected character at index ${d}`);r=e.slice(c,d),c=l=-1}else if(n){if(1!==Ie[h])throw new SyntaxError(`Unexpected character at index ${d}`);-1===c?c=d:i||(i=!0),n=!1}else if(a)if(1===Ie[h])-1===c&&(c=d);else if(34===h&&-1!==c)a=!1,l=d;else{if(92!==h)throw new SyntaxError(`Unexpected character at index ${d}`);n=!0}else if(34===h&&61===e.charCodeAt(d-1))a=!0;else if(-1===l&&1===Ie[h])-1===c&&(c=d);else if(-1===c||32!==h&&9!==h){if(59!==h&&44!==h)throw new SyntaxError(`Unexpected character at index ${d}`);{if(-1===c)throw new SyntaxError(`Unexpected character at index ${d}`);-1===l&&(l=d);let n=e.slice(c,l);i&&(n=n.replace(/\\/g,""),i=!1),Ae(o,r,n),44===h&&(Ae(t,s,o),o=Object.create(null),s=void 0),r=void 0,c=l=-1}}else-1===l&&(l=d);if(-1===c||a||32===h||9===h)throw new SyntaxError("Unexpected end of input");-1===l&&(l=d);const f=e.slice(c,l);return void 0===s?Ae(t,f,o):(void 0===r?Ae(o,f,!0):Ae(o,r,i?f.replace(/\\/g,""):f),Ae(t,s,o)),t}};const De=o,We=i,Fe=n,je=a,Ge=c,{randomBytes:Ve,createHash:qe}=r,{URL:$e}=h,He=D,ze=ne,Ye=ye,{BINARY_TYPES:Xe,EMPTY_BUFFER:Ke,GUID:Ze,kForOnEventAttribute:Je,kListener:Qe,kStatusCode:et,kWebSocket:tt,NOOP:st}=g,{EventTarget:{addEventListener:rt,removeEventListener:ot}}=Ue,{format:it,parse:nt}=Me,{toBuffer:at}=E,ct=Symbol("kAborted"),ht=[8,13],lt=["CONNECTING","OPEN","CLOSING","CLOSED"],dt=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/;class ft extends De{constructor(e,t,s){super(),this._binaryType=Xe[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=Ke,this._closeTimer=null,this._extensions={},this._paused=!1,this._protocol="",this._readyState=ft.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,null!==e?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,void 0===t?t=[]:Array.isArray(t)||("object"==typeof t&&null!==t?(s=t,t=[]):t=[t]),ut(this,e,t,s)):(this._autoPong=s.autoPong,this._isServer=!0)}get binaryType(){return this._binaryType}set binaryType(e){Xe.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(e,t,s){const r=new ze({allowSynchronousEvents:s.allowSynchronousEvents,binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:s.maxPayload,skipUTF8Validation:s.skipUTF8Validation});this._sender=new Ye(e,this._extensions,s.generateMask),this._receiver=r,this._socket=e,r[tt]=this,e[tt]=this,r.on("conclude",vt),r.on("drain",bt),r.on("error",kt),r.on("message",Et),r.on("ping",wt),r.on("pong",xt),e.setTimeout&&e.setTimeout(0),e.setNoDelay&&e.setNoDelay(),t.length>0&&e.unshift(t),e.on("close",Nt),e.on("data",Tt),e.on("end",Ct),e.on("error",Lt),this._readyState=ft.OPEN,this.emit("open")}emitClose(){if(!this._socket)return this._readyState=ft.CLOSED,void this.emit("close",this._closeCode,this._closeMessage);this._extensions[He.extensionName]&&this._extensions[He.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=ft.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==ft.CLOSED)if(this.readyState!==ft.CONNECTING)this.readyState!==ft.CLOSING?(this._readyState=ft.CLOSING,this._sender.close(e,t,!this._isServer,(e=>{e||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())})),this._closeTimer=setTimeout(this._socket.destroy.bind(this._socket),3e4)):this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end();else{const e="WebSocket was closed before the connection was established";yt(this,this._req,e)}}pause(){this.readyState!==ft.CONNECTING&&this.readyState!==ft.CLOSED&&(this._paused=!0,this._socket.pause())}ping(e,t,s){if(this.readyState===ft.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(s=e,e=t=void 0):"function"==typeof t&&(s=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===ft.OPEN?(void 0===t&&(t=!this._isServer),this._sender.ping(e||Ke,t,s)):gt(this,e,s)}pong(e,t,s){if(this.readyState===ft.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(s=e,e=t=void 0):"function"==typeof t&&(s=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===ft.OPEN?(void 0===t&&(t=!this._isServer),this._sender.pong(e||Ke,t,s)):gt(this,e,s)}resume(){this.readyState!==ft.CONNECTING&&this.readyState!==ft.CLOSED&&(this._paused=!1,this._receiver._writableState.needDrain||this._socket.resume())}send(e,t,s){if(this.readyState===ft.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof t&&(s=t,t={}),"number"==typeof e&&(e=e.toString()),this.readyState!==ft.OPEN)return void gt(this,e,s);const r={binary:"string"!=typeof e,mask:!this._isServer,compress:!0,fin:!0,...t};this._extensions[He.extensionName]||(r.compress=!1),this._sender.send(e||Ke,r,s)}terminate(){if(this.readyState!==ft.CLOSED)if(this.readyState!==ft.CONNECTING)this._socket&&(this._readyState=ft.CLOSING,this._socket.destroy());else{const e="WebSocket was closed before the connection was established";yt(this,this._req,e)}}}function ut(e,t,s,r){const o={allowSynchronousEvents:!1,autoPong:!0,protocolVersion:ht[1],maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...r,createConnection:void 0,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:"GET",host:void 0,path:void 0,port:void 0};if(e._autoPong=o.autoPong,!ht.includes(o.protocolVersion))throw new RangeError(`Unsupported protocol version: ${o.protocolVersion} (supported versions: ${ht.join(", ")})`);let i;if(t instanceof $e)i=t;else try{i=new $e(t)}catch(e){throw new SyntaxError(`Invalid URL: ${t}`)}"http:"===i.protocol?i.protocol="ws:":"https:"===i.protocol&&(i.protocol="wss:"),e._url=i.href;const n="wss:"===i.protocol,a="ws+unix:"===i.protocol;let c;if("ws:"===i.protocol||n||a?a&&!i.pathname?c="The URL's pathname is empty":i.hash&&(c="The URL contains a fragment identifier"):c='The URL\'s protocol must be one of "ws:", "wss:", "http:", "https", or "ws+unix:"',c){const t=new SyntaxError(c);if(0===e._redirects)throw t;return void _t(e,t)}const h=n?443:80,l=Ve(16).toString("base64"),d=n?We.request:Fe.request,f=new Set;let u,_;if(o.createConnection=n?mt:pt,o.defaultPort=o.defaultPort||h,o.port=i.port||h,o.host=i.hostname.startsWith("[")?i.hostname.slice(1,-1):i.hostname,o.headers={...o.headers,"Sec-WebSocket-Version":o.protocolVersion,"Sec-WebSocket-Key":l,Connection:"Upgrade",Upgrade:"websocket"},o.path=i.pathname+i.search,o.timeout=o.handshakeTimeout,o.perMessageDeflate&&(u=new He(!0!==o.perMessageDeflate?o.perMessageDeflate:{},!1,o.maxPayload),o.headers["Sec-WebSocket-Extensions"]=it({[He.extensionName]:u.offer()})),s.length){for(const e of s){if("string"!=typeof e||!dt.test(e)||f.has(e))throw new SyntaxError("An invalid or duplicated subprotocol was specified");f.add(e)}o.headers["Sec-WebSocket-Protocol"]=s.join(",")}if(o.origin&&(o.protocolVersion<13?o.headers["Sec-WebSocket-Origin"]=o.origin:o.headers.Origin=o.origin),(i.username||i.password)&&(o.auth=`${i.username}:${i.password}`),a){const e=o.path.split(":");o.socketPath=e[0],o.path=e[1]}if(o.followRedirects){if(0===e._redirects){e._originalIpc=a,e._originalSecure=n,e._originalHostOrSocketPath=a?o.socketPath:i.host;const t=r&&r.headers;if(r={...r,headers:{}},t)for(const[e,s]of Object.entries(t))r.headers[e.toLowerCase()]=s}else if(0===e.listenerCount("redirect")){const t=a?!!e._originalIpc&&o.socketPath===e._originalHostOrSocketPath:!e._originalIpc&&i.host===e._originalHostOrSocketPath;(!t||e._originalSecure&&!n)&&(delete o.headers.authorization,delete o.headers.cookie,t||delete o.headers.host,o.auth=void 0)}o.auth&&!r.headers.authorization&&(r.headers.authorization="Basic "+Buffer.from(o.auth).toString("base64")),_=e._req=d(o),e._redirects&&e.emit("redirect",e.url,_)}else _=e._req=d(o);o.timeout&&_.on("timeout",(()=>{yt(e,_,"Opening handshake has timed out")})),_.on("error",(t=>{null===_||_[ct]||(_=e._req=null,_t(e,t))})),_.on("response",(i=>{const n=i.headers.location,a=i.statusCode;if(n&&o.followRedirects&&a>=300&&a<400){if(++e._redirects>o.maxRedirects)return void yt(e,_,"Maximum redirects exceeded");let i;_.abort();try{i=new $e(n,t)}catch(t){const s=new SyntaxError(`Invalid URL: ${n}`);return void _t(e,s)}ut(e,i,s,r)}else e.emit("unexpected-response",_,i)||yt(e,_,`Unexpected server response: ${i.statusCode}`)})),_.on("upgrade",((t,s,r)=>{if(e.emit("upgrade",t),e.readyState!==ft.CONNECTING)return;if(_=e._req=null,"websocket"!==t.headers.upgrade.toLowerCase())return void yt(e,s,"Invalid Upgrade header");const i=qe("sha1").update(l+Ze).digest("base64");if(t.headers["sec-websocket-accept"]!==i)return void yt(e,s,"Invalid Sec-WebSocket-Accept header");const n=t.headers["sec-websocket-protocol"];let a;if(void 0!==n?f.size?f.has(n)||(a="Server sent an invalid subprotocol"):a="Server sent a subprotocol but none was requested":f.size&&(a="Server sent no subprotocol"),a)return void yt(e,s,a);n&&(e._protocol=n);const c=t.headers["sec-websocket-extensions"];if(void 0!==c){if(!u){return void yt(e,s,"Server sent a Sec-WebSocket-Extensions header but no extension was requested")}let t;try{t=nt(c)}catch(t){return void yt(e,s,"Invalid Sec-WebSocket-Extensions header")}const r=Object.keys(t);if(1!==r.length||r[0]!==He.extensionName){return void yt(e,s,"Server indicated an extension that was not requested")}try{u.accept(t[He.extensionName])}catch(t){return void yt(e,s,"Invalid Sec-WebSocket-Extensions header")}e._extensions[He.extensionName]=u}e.setSocket(s,r,{allowSynchronousEvents:o.allowSynchronousEvents,generateMask:o.generateMask,maxPayload:o.maxPayload,skipUTF8Validation:o.skipUTF8Validation})})),o.finishRequest?o.finishRequest(_,e):_.end()}function _t(e,t){e._readyState=ft.CLOSING,e.emit("error",t),e.emitClose()}function pt(e){return e.path=e.socketPath,je.connect(e)}function mt(e){return e.path=void 0,e.servername||""===e.servername||(e.servername=je.isIP(e.host)?"":e.host),Ge.connect(e)}function yt(e,t,s){e._readyState=ft.CLOSING;const r=new Error(s);Error.captureStackTrace(r,yt),t.setHeader?(t[ct]=!0,t.abort(),t.socket&&!t.socket.destroyed&&t.socket.destroy(),process.nextTick(_t,e,r)):(t.destroy(r),t.once("error",e.emit.bind(e,"error")),t.once("close",e.emitClose.bind(e)))}function gt(e,t,s){if(t){const s=at(t).length;e._socket?e._sender._bufferedBytes+=s:e._bufferedAmount+=s}if(s){const t=new Error(`WebSocket is not open: readyState ${e.readyState} (${lt[e.readyState]})`);process.nextTick(s,t)}}function vt(e,t){const s=this[tt];s._closeFrameReceived=!0,s._closeMessage=t,s._closeCode=e,void 0!==s._socket[tt]&&(s._socket.removeListener("data",Tt),process.nextTick(Ot,s._socket),1005===e?s.close():s.close(e,t))}function bt(){const e=this[tt];e.isPaused||e._socket.resume()}function kt(e){const t=this[tt];void 0!==t._socket[tt]&&(t._socket.removeListener("data",Tt),process.nextTick(Ot,t._socket),t.close(e[et])),t.emit("error",e)}function St(){this[tt].emitClose()}function Et(e,t){this[tt].emit("message",e,t)}function wt(e){const t=this[tt];t._autoPong&&t.pong(e,!this._isServer,st),t.emit("ping",e)}function xt(e){this[tt].emit("pong",e)}function Ot(e){e.resume()}function Nt(){const e=this[tt];let t;this.removeListener("close",Nt),this.removeListener("data",Tt),this.removeListener("end",Ct),e._readyState=ft.CLOSING,this._readableState.endEmitted||e._closeFrameReceived||e._receiver._writableState.errorEmitted||null===(t=e._socket.read())||e._receiver.write(t),e._receiver.end(),this[tt]=void 0,clearTimeout(e._closeTimer),e._receiver._writableState.finished||e._receiver._writableState.errorEmitted?e.emitClose():(e._receiver.on("error",St),e._receiver.on("finish",St))}function Tt(e){this[tt]._receiver.write(e)||this.pause()}function Ct(){const e=this[tt];e._readyState=ft.CLOSING,e._receiver.end(),this.end()}function Lt(){const e=this[tt];this.removeListener("error",Lt),this.on("error",st),e&&(e._readyState=ft.CLOSING,this.destroy())}Object.defineProperty(ft,"CONNECTING",{enumerable:!0,value:lt.indexOf("CONNECTING")}),Object.defineProperty(ft.prototype,"CONNECTING",{enumerable:!0,value:lt.indexOf("CONNECTING")}),Object.defineProperty(ft,"OPEN",{enumerable:!0,value:lt.indexOf("OPEN")}),Object.defineProperty(ft.prototype,"OPEN",{enumerable:!0,value:lt.indexOf("OPEN")}),Object.defineProperty(ft,"CLOSING",{enumerable:!0,value:lt.indexOf("CLOSING")}),Object.defineProperty(ft.prototype,"CLOSING",{enumerable:!0,value:lt.indexOf("CLOSING")}),Object.defineProperty(ft,"CLOSED",{enumerable:!0,value:lt.indexOf("CLOSED")}),Object.defineProperty(ft.prototype,"CLOSED",{enumerable:!0,value:lt.indexOf("CLOSED")}),["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach((e=>{Object.defineProperty(ft.prototype,e,{enumerable:!0})})),["open","error","close","message"].forEach((e=>{Object.defineProperty(ft.prototype,`on${e}`,{enumerable:!0,get(){for(const t of this.listeners(e))if(t[Je])return t[Qe];return null},set(t){for(const t of this.listeners(e))if(t[Je]){this.removeListener(e,t);break}"function"==typeof t&&this.addEventListener(e,t,{[Je]:!0})}})})),ft.prototype.addEventListener=rt,ft.prototype.removeEventListener=ot;var Rt,Pt=m(ft),Ut={1e3:"Normal Closure",1001:"Going Away",1002:"Protocol Error",1003:"Unsupported Data",1005:"No Status Received",1006:"Abnormal Closure",1007:"Invalid frame payload data",1008:"Policy Violation",1009:"Message too big",1010:"Missing Extension",1011:"Internal Error",1012:"Service Restart",1013:"Try Again Later",1014:"Bad Gateway",1015:"TLS Handshake"},Bt=["CONNECTING","OPEN","CLOSING","CLOSED"],It=(Rt=0,function(){return++Rt}),At=function(){function e(e,t,s){var r=this;this._lastUsed=0,this._buffer=[],this.id=It(),this._socket=t&&t.length>0?new Pt(e,t,s):new Pt(e,s),this.refresh(),this._socket.onmessage=function(e){r._buffer.push({type:"message",data:e.data})},this._socket.on("close",(function(e){r.closeReason=e})),this._socket.onerror=function(){r._buffer.push({type:"error"})}}return e.prototype.refresh=function(){this._lastUsed=(new Date).getTime()},Object.defineProperty(e.prototype,"age",{get:function(){return(new Date).getTime()-this._lastUsed},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onopen",{get:function(){return this._socket.onopen},set:function(e){this._socket.onopen=e},enumerable:!1,configurable:!0}),e.prototype.send=function(e){var t=this;return new Promise((function(s,r){t._socket.send(e,(function(e){e?r(e):s()}))}))},e.prototype.close=function(e,t){var s=this;return void 0===e&&(e=1e3),new Promise((function(r){3===s._socket.readyState?r():(s._socket.once("close",r),s._socket.close(e,t))}))},e.prototype.getBuffer=function(e){void 0===e&&(e=!1);var t=this._buffer;return this.refresh(),e&&(this._buffer=[]),{readyState:this._socket.readyState,readyStateName:Bt[this._socket.readyState],closeReason:this.closeReason,closeReasonName:Ut[this.closeReason],buffer:t}},e}(),Mt=function(e){var t=this;this.sockets={},this.onActivityTimer=function(){var e=(new Date).getTime();Object.values(t.sockets).filter((function(s){return e-s.lastActive>t.activityTimeout})).forEach((function(e){var s=e.socket;return t._close(s,1e3,"Connection Timeout Reached")}))},this.logEvent=function(e,s,r){for(var o in t.sockets)t.sockets[o].socket===s&&(t.sockets[o].lastActive=(new Date).getTime());t.log([r,s&&s.id?"#".concat(s.id):"",e].filter((function(e){return!!e})).join(" | "))},this.createSocket=function(e){return new Promise((function(s,r){try{var o=p(),i=(t.sockets[o]={socket:new At(t.wsUrl,e),lastActive:(new Date).getTime()}).socket,n=!1;i._socket.on("close",(function(e){if(n)s=e in Ut?" (".concat(Ut[e],")"):"",t.logEvent("Socket closed: "+e+s,i,"🟠");else{var s=e in Ut?" (".concat(Ut[e],")"):"";delete t.sockets[o],t.logEvent("Socket closed: "+e+s,i,"🟠"),t.logEvent("Socket deleted: ".concat(e," (Initial connection failed)"),i,"🔴"),r({message:"Connection failed!",socket:i,error:new Error("Connection failed")})}})),i.onopen=function(){t.logEvent("Socket opened: "+o,i,"🟢"),setTimeout((function(){3!==i._socket.readyState&&(n=!0,s({key:o,socket:i}))}),100)},i._socket.on("message",(function(e){t.logEvent("Receive: "+(["string","boolean","number"].includes(typeof e)?e:JSON.stringify(e)),i,"⏬")}))}catch(e){r({message:"Connection failed!",socket:void 0,error:e})}}))},this.getSocket=function(e){return new Promise((function(s,r){var o=t.sockets[e||""];o||r({message:"Socket not found!"}),o.lastActive=(new Date).getTime(),s(o.socket)}))},this.sendMessages=function(e,s){return t.getSocket(e).then((function(e){return Array.isArray(s)?Promise.all(s.map((function(s){return t.logEvent("Send: "+s.toString(),e,"⏫"),e.send(s)}))).catch((function(s){throw t.logEvent("Send error: "+s.message,e,"🟡"),{message:"Error sending messages",error:s,socket:e}})).then((function(){return e})):e}))},this._close=function(e,s,r){return void 0===s&&(s=1e3),e.close(s,r).then((function(){for(var o in t.sockets)if(t.sockets[o].socket===e){delete t.sockets[o];break}t.logEvent("Socket deleted: ".concat(s," (").concat(r||"no message",")"),e,"🔴"),t.logEvent("".concat(Object.keys(t.sockets).length," sockets remaining"),void 0,"ℹ️ ")}))},this.close=function(e,s,r){return void 0===e&&(e=""),t.getSocket(e).then((function(e){return t._close(e,s,r).then((function(){return e}))}))},this.wsUrl=e.url,this.log=e.log||function(){},this.activityTimeout=e.activityTimeout||1e4,setInterval(this.onActivityTimer,Math.max(500,this.activityTimeout/5))},Dt=function(e,t,s){void 0===s&&(s=200),e.statusCode=s,e.setHeader("Content-Type","application/json"),e.write(JSON.stringify(t)),e.end()},Wt=function(e,t,s,r,o){void 0===o&&(o=400),Dt(e,{message:t,socket:null===r?null:r?r.getBuffer(!0):{readyState:3,readyStateName:Bt[3],closeReason:1006,closeReasonName:Ut[1006],buffer:[]},error:s},o)},Ft=function(e,t,s,r,o){void 0===s&&(s={}),void 0===o&&(o=200),Dt(e,Object.assign({message:t,socket:r?r.getBuffer(!0):{readyState:3,readyStateName:Bt[3],closeReason:1006,closeReasonName:Ut[1006],buffer:[]}},s),o)};module.exports=function(e){var t=e.express,s=e.remoteUrl,r=e.log,o=e.baseUrl,i=e.activityTimeout,n=t(),a=new Mt({url:s,log:r,activityTimeout:i});return n.use((function(e,s,r){s.setHeader("Access-Control-Allow-Origin","*"),s.setHeader("Access-Control-Allow-Methods","*"),s.setHeader("Access-Control-Allow-Headers","*"),t.json()(e,s,(function(e){e?Wt(s,"Invalid JSON",new Error(e.type),null,400):r()}))})),n.put("/",(function(e,t){var s=Array.isArray(e.body.protocols)?e.body.protocols:[];a.createSocket(s).then((function(s){var r=s.key,i=s.socket,n=function(e){return("function"==typeof o?o(e):o)||e.protocol+"://"+e.get("host")}(e)+e.originalUrl+"/"+r;Ft(t,"Connection successful!",{url:n},i)})).catch((function(e){var s=e||{},r=s.message,o=s.socket,i=s.error;Wt(t,r||"Connection failed!",i,o)}))})),n.get("/:key",(function(e,t){a.getSocket(e.params.key).then((function(e){Ft(t,"Socket found",void 0,e)})).catch((function(e){Wt(t,e.message||"Unknown socket",e,void 0,404)}))})),n.post("/:key",(function(e,t){a.sendMessages(e.params.key,e.body).then((function(e){Ft(t,"Messages sent",void 0,e)})).catch((function(e){"socket"in e?Wt(t,e.message,e.error,e.socket,400):Wt(t,e.message||"Unknown socket",e,void 0,404)}))})),n.delete("/:key",(function(e,t){a.close(e.params.key).then((function(e){Ft(t,"Socket closed",void 0,e)})).catch((function(e){Wt(t,e.message||"Unknown socket",e,void 0,404)}))})),n};
